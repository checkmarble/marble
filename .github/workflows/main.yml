name: Release Charts

on:
  release:
    types:
      - created
    # branches:
    #   - main
env:
  CHART_NAME: marble-application
  IMAGE_TAG: 0.1.0
  # ARTIFACT_REGISTRY_HOST_NAME: europe-west1-docker-.pkg.dev
  # INFRA_PROJECT_ID: marble-infra
  # ARTIFACT_REGISTRY_REPOSITORY: helm-chart-tests

jobs:
  release:
    # depending on default permission settings for your org (contents being read-only or read-write for workloads), you will have to add permissions
    # see: https://docs.github.com/en/actions/security-guides/automatic-token-authentication#modifying-the-permissions-for-the-github_token
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Helm
        uses: azure/setup-helm@v4
        env:
          GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"

      - name: Google Auth
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v2'
        with:
         version: '>= 363.0.0'

      - name: Login to artifact registry
        run: |
          gcloud auth configure-docker ${{vars.ARTIFACT_REGISTRY_HOST_NAME}} --quiet

      - name: Helm package
        run: |
          helm package . --version $IMAGE_TAG

      - name: Helm push
        if: ${{ github.event_name == 'push' }}
        run: |
          helm push $CHART_NAME-$IMAGE_TAG.tgz oci://${{vars.ARTIFACT_REGISTRY_HOST_NAME}}/${{vars.INFRA_PROJECT_ID}}/${{vars.ARTIFACT_REGISTRY_REPOSITORY}}
      # - name: Run chart-releaser
      #   uses: helm/chart-releaser-action@v1.6.0
      #   with:
      #     charts_dir: kubernetes/charts
      #     version: 1.16.0
      #   env:
      #     CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
